---
date: 2020-1-11
layout: default
title: vip
---

# vip

![image-20200111134715261](/Users/daitechang/Documents/hexo_blog/source/_posts/pic/image-20200111134715261.png)

公有ip地址有个组织统一分配，你需要去买，私有ip地址可以自己分配

设置本地私有ip

```bash
$ sudo ifconfig eth1 10.0.0.1/24
$ sudo ifconfig eth1 up
```

虚拟IP即VIP，这只是一个概念而已，可能会误导你，实际上就是heartbeat临时绑定在物理网卡上的别名（heartbeat3以上也采用了辅助IP），**如eth0:x ，x为0-255的任意数字，你可以在一块网卡上绑定多个别名**。这个VIP可以看作是你上网的QQ网名、昵称、外号等。
**在实际生产环境中，需要在DNS配置中把网站域名地址解析到这个VIP地址，由这个VIP对用户提供服务**。如：把www.zhangcong.top解析到VIP 1.1.1.1 上。

## 别名ip

由Linux系统的 ifconfig 命令来创建和维护

## 辅助ip

由Linux系统的ip命令创建和维护

heartbeat3 版本起，不再使用别名，而是使用辅助IP提供服务，而 keepalived 软件一直都是使用的辅助IP技术

## 手动设置vip

1,ifconfig查看当前活动网卡。如：eth0

2,执行

**ifconfig eth0:0 166.111.69.100 netmask 255.255.255.0 up**

进行vip添加

3，执行ifconfig查看是否生效

4，测试 ping 166.111.69.100

5,写在/etc/rc.local里进行开机自动设置

## 使用keepalived增加vip

设置/etc/keepalived/keepalived.conf

```shell
global_defs {
     notification_email {
     saltstack@163.com
   }
   notification_email_from dba@dbserver.com
   smtp_server 127.0.0.1
   smtp_connect_timeout 30
   router_id MySQL-HA
}

vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 51
    priority 150
    advert_int 1
    nopreempt

    authentication {
    auth_type PASS
    auth_pass 1111
    }

    virtual_ipaddress {
        192.168.0.88
    }
}
```

采用的是**ip addr add 192.168.40.20/24 dev eth0** 增加vip

## HA

实现HA的方式，一般采用两台机器同时完成一项功能，比如数据库服务器，平常只有一台机器对外提供服务，另一台机器作为热备，当这台机器出现故障时，自动动态切换到另一台热备的机器。

### 怎么实现故障检测的那？

​    心跳，采用定时发送一个数据包，如果机器多长时间没响应，就认为是发生故障，自动切换到热备的机器上去。

### 怎么实现自动切换那？

​    虚IP。何为虚IP那，就是一个未分配给真实主机的IP，也就是说对外提供数据库服务器的主机除了有一个真实IP外还有一个虚IP，使用这两个IP中的 任意一个都可以连接到这台主机，所有项目中数据库链接一项配置的都是这个虚IP，当服务器发生故障无法对外提供服务时，动态将这个虚IP切换到备用主机。

## Keepalived

以检测web服务器为例，Keepalived从3个层次来检测服务器的状态

**（1）IP层**

看网络是否正常

Keepalived定期ping目标服务器，如果此IP地址没有激活，Keepalived便报告这台服务器失效，进行移除

**（2）TCP层**

看web服务器端口是否正常

例如一般web服务的端口为80，Keepalived定期查看80端口，如果没有启动，报告失效

**（3）应用层**

看应用程序是否正常

Keepalived将根据用户的设定，检查服务器程序的运行是否正常，如果与用户的设定不相符，则Keepalived将把服务器从服务器群中剔除



## reference

https://blog.csdn.net/chengxuyuanyonghu/article/details/83539966